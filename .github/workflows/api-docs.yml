name: API Documentation Version Control

on:
  workflow_dispatch:  # 🔄 수동 실행 가능하도록 추가
    inputs:
      force_run:
        description: '강제 실행 여부'
        required: false
        default: 'false'
  push:
    branches: [main, develop, master]
    paths: 
      - '**/views/**'
      - '**/serializers.py' 
      - '**/urls/**'
      - 'user/**'
  pull_request:
    branches: [main, develop, master]
    paths:
      - '**/views/**'
      - '**/serializers.py'
      - '**/urls/**'
      - 'user/**'

jobs:
  api-version-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🔄 Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          echo "⚠️ requirements.txt not found"
          pip install django djangorestframework drf-spectacular python-decouple
        fi
        
    - name: 🔧 Django Setup Check
      env:
        DJANGO_SETTINGS_MODULE: config.settings
        DEBUG: 'True'
        SECRET_KEY: 'test-secret-key-for-github-actions'
        DATABASE_URL: 'sqlite:///test.db'
      run: |
        echo "🔍 Django 설정 확인 중..."
        python manage.py check || echo "⚠️ Django check failed"
        
    - name: 📋 Generate API Schema
      env:
        DJANGO_SETTINGS_MODULE: config.settings
        DEBUG: 'True'
        SECRET_KEY: 'test-secret-key-for-github-actions'
        DATABASE_URL: 'sqlite:///test.db'
      run: |
        echo "📊 API 스키마 생성 중..."
        mkdir -p api-docs
        python manage.py spectacular --color --file api-docs/schema-new.json || echo "⚠️ Schema generation failed"
        
        if [ -f "api-docs/schema-new.json" ]; then
          echo "✅ 스키마 파일 생성 성공"
          echo "📊 파일 크기: $(wc -c < api-docs/schema-new.json) bytes"
        else
          echo "❌ 스키마 파일 생성 실패"
          exit 1
        fi
        
    - name: 🔍 Check API Changes
      run: |
        echo "🔄 API 변경사항 확인 중..."
        if [ -f "api-docs/schema-old.json" ]; then
          if ! diff -q api-docs/schema-old.json api-docs/schema-new.json > /dev/null 2>&1; then
            echo "🔄 API 스키마 변경 감지됨!"
            echo "SCHEMA_CHANGED=true" >> $GITHUB_ENV
            echo "::notice::API 스키마가 변경되었습니다."
          else
            echo "✅ API 스키마 변경사항 없음"
            echo "SCHEMA_CHANGED=false" >> $GITHUB_ENV
          fi
        else
          echo "🆕 첫 번째 스키마 생성"
          echo "SCHEMA_CHANGED=true" >> $GITHUB_ENV
        fi
        
    - name: 📝 Update Changelog
      if: env.SCHEMA_CHANGED == 'true'
      run: |
        echo "📝 변경 이력 업데이트 중..."
        mkdir -p docs
        if [ ! -f docs/API_CHANGELOG.md ]; then
          echo "# API 변경 이력" > docs/API_CHANGELOG.md
          echo "" >> docs/API_CHANGELOG.md
          echo "이 파일은 GitHub Actions에 의해 자동으로 생성됩니다." >> docs/API_CHANGELOG.md
          echo "" >> docs/API_CHANGELOG.md
        fi
        
        echo "## API Changes - $(date '+%Y-%m-%d %H:%M:%S')" >> docs/API_CHANGELOG.md
        echo "- **브랜치**: ${{ github.ref_name }}" >> docs/API_CHANGELOG.md
        echo "- **커밋**: [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> docs/API_CHANGELOG.md
        echo "- **작성자**: ${{ github.actor }}" >> docs/API_CHANGELOG.md
        echo "- **이벤트**: ${{ github.event_name }}" >> docs/API_CHANGELOG.md
        echo "- **변경된 파일들**:" >> docs/API_CHANGELOG.md
        
        if [ "${{ github.event_name }}" = "push" ]; then
          git diff --name-only HEAD~1 | grep -E '\.(py)$' | sed 's/^/  - /' >> docs/API_CHANGELOG.md || echo "  - 변경된 Python 파일 없음" >> docs/API_CHANGELOG.md
        else
          echo "  - 수동 실행 또는 Pull Request" >> docs/API_CHANGELOG.md
        fi
        echo "" >> docs/API_CHANGELOG.md
        
    - name: 💾 Commit changes
      if: env.SCHEMA_CHANGED == 'true'
      run: |
        echo "💾 변경사항 커밋 중..."
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        if [ -f "api-docs/schema-new.json" ]; then
          cp api-docs/schema-new.json api-docs/schema-old.json
          git add api-docs/schema-old.json
          echo "✅ 스키마 파일 추가됨"
        fi
        
        if [ -f "docs/API_CHANGELOG.md" ]; then
          git add docs/API_CHANGELOG.md
          echo "✅ 변경 로그 추가됨"
        fi
        
        if ! git diff --staged --quiet; then
          git commit -m "📝 Update API schema and changelog

Auto-generated by GitHub Actions
- Branch: ${{ github.ref_name }}
- Commit: ${{ github.sha }}
- Event: ${{ github.event_name }}
- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          echo "✅ 커밋 생성 완료"
          git push origin ${{ github.ref_name }} || echo "⚠️ Push failed - 권한을 확인하세요"
        else
          echo "ℹ️ 커밋할 변경사항이 없습니다"
        fi

    - name: 📊 Summary
      run: |
        echo "## 🎉 워크플로우 완료!" 
        echo "- **브랜치**: ${{ github.ref_name }}"
        echo "- **트리거**: ${{ github.event_name }}"
        echo "- **스키마 변경**: ${SCHEMA_CHANGED:-false}"
        echo "- **시간**: $(date)"
        
        echo ""
        echo "## 📁 생성된 파일들:"
        if [ -f "api-docs/schema-old.json" ]; then
          echo "✅ api-docs/schema-old.json ($(wc -c < api-docs/schema-old.json) bytes)"
        fi
        if [ -f "docs/API_CHANGELOG.md" ]; then
          echo "✅ docs/API_CHANGELOG.md"
          echo "📄 최근 5줄:"
          tail -5 docs/API_CHANGELOG.md | sed 's/^/    /'
        fi