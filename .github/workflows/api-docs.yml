name: API Documentation Version Control

on:
  workflow_dispatch:  # ğŸ”„ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ ì¶”ê°€
    inputs:
      force_run:
        description: 'ê°•ì œ ì‹¤í–‰ ì—¬ë¶€'
        required: false
        default: 'false'
  push:
    branches: [main, develop, master]
    paths: 
      - '**/views/**'
      - '**/serializers.py' 
      - '**/urls/**'
      - 'user/**'
  pull_request:
    branches: [main, develop, master]
    paths:
      - '**/views/**'
      - '**/serializers.py'
      - '**/urls/**'
      - 'user/**'

jobs:
  api-version-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        token: ${{ secrets.GITHUB_TOKEN }}  # ëª…ì‹œì ìœ¼ë¡œ í† í° ì¶”ê°€
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          echo "âš ï¸ requirements.txt not found"
          pip install django djangorestframework drf-spectacular
        fi
        
    - name: ğŸ”§ Django Setup Check
      env:
        DJANGO_SETTINGS_MODULE: config.settings  # Django ì„¤ì • ëª¨ë“ˆ ëª…ì‹œ
      run: |
        echo "ğŸ” Django ì„¤ì • í™•ì¸ ì¤‘..."
        python manage.py check || echo "âš ï¸ Django check failed"
        
    - name: ğŸ“‹ Generate API Schema
      env:
        DJANGO_SETTINGS_MODULE: config.settings
      run: |
        echo "ğŸ“Š API ìŠ¤í‚¤ë§ˆ ìƒì„± ì¤‘..."
        mkdir -p api-docs
        python manage.py spectacular --color --file api-docs/schema-new.json || echo "âš ï¸ Schema generation failed"
        
    - name: ğŸ” Check API Changes
      run: |
        echo "ğŸ”„ API ë³€ê²½ì‚¬í•­ í™•ì¸ ì¤‘..."
        if [ -f "api-docs/schema-old.json" ]; then
          if ! diff -q api-docs/schema-old.json api-docs/schema-new.json > /dev/null 2>&1; then
            echo "ğŸ”„ API ìŠ¤í‚¤ë§ˆ ë³€ê²½ ê°ì§€ë¨!"
            echo "SCHEMA_CHANGED=true" >> $GITHUB_ENV
            echo "::notice::API ìŠ¤í‚¤ë§ˆê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âœ… API ìŠ¤í‚¤ë§ˆ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            echo "SCHEMA_CHANGED=false" >> $GITHUB_ENV
          fi
        else
          echo "ğŸ†• ì²« ë²ˆì§¸ ìŠ¤í‚¤ë§ˆ ìƒì„±"
          echo "SCHEMA_CHANGED=true" >> $GITHUB_ENV
        fi
        
    - name: ğŸ“ Update Changelog
      if: env.SCHEMA_CHANGED == 'true'
      run: |
        echo "ğŸ“ ë³€ê²½ ì´ë ¥ ì—…ë°ì´íŠ¸ ì¤‘..."
        mkdir -p docs
        if [ ! -f docs/API_CHANGELOG.md ]; then
          echo "# API ë³€ê²½ ì´ë ¥" > docs/API_CHANGELOG.md
          echo "" >> docs/API_CHANGELOG.md
        fi
        echo "## API Changes - $(date '+%Y-%m-%d %H:%M:%S')" >> docs/API_CHANGELOG.md
        echo "- **ë¸Œëœì¹˜**: ${{ github.ref_name }}" >> docs/API_CHANGELOG.md
        echo "- **ì»¤ë°‹**: [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> docs/API_CHANGELOG.md
        echo "- **ì‘ì„±ì**: ${{ github.actor }}" >> docs/API_CHANGELOG.md
        echo "- **ë³€ê²½ëœ íŒŒì¼ë“¤**:" >> docs/API_CHANGELOG.md
        git diff --name-only HEAD~1 | grep -E '\.(py)$' | sed 's/^/  - /' >> docs/API_CHANGELOG.md || echo "  - ë³€ê²½ëœ Python íŒŒì¼ ì—†ìŒ" >> docs/API_CHANGELOG.md
        echo "" >> docs/API_CHANGELOG.md
        
    - name: ğŸ’¾ Commit changes
      if: env.SCHEMA_CHANGED == 'true'
      run: |
        echo "ğŸ’¾ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì¤‘..."
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # ìŠ¤í‚¤ë§ˆ íŒŒì¼ ì—…ë°ì´íŠ¸
        if [ -f "api-docs/schema-new.json" ]; then
          cp api-docs/schema-new.json api-docs/schema-old.json
          git add api-docs/schema-old.json
        fi
        
        # ë³€ê²½ ë¡œê·¸ ì¶”ê°€
        git add docs/API_CHANGELOG.md
        
        # ì»¤ë°‹ (ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ“ Update API schema and changelog

Auto-generated by GitHub Actions
- Branch: ${{ github.ref_name }}
- Commit: ${{ github.sha }}
- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Push (ê¶Œí•œì´ ìˆëŠ” ê²½ìš°ì—ë§Œ)
          git push || echo "âš ï¸ Push failed - ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”"
        else
          echo "â„¹ï¸ ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
        fi

    - name: ğŸ“Š Summary
      run: |
        echo "## ğŸ‰ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ!" 
        echo "- **ë¸Œëœì¹˜**: ${{ github.ref_name }}"
        echo "- **íŠ¸ë¦¬ê±°**: ${{ github.event_name }}"
        echo "- **ìŠ¤í‚¤ë§ˆ ë³€ê²½**: ${SCHEMA_CHANGED:-false}"
        echo "- **ì‹œê°„**: $(date)"